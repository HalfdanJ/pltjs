<script src="js/peg.js"></script>
<script src="js/plt.js"></script>

<title>Snipe</title>

<pre id="grammar">
  start                         = expression*

  expression                    = space exp:expression_content space ('\n' / ';' )* space { return exp }
  terminated_expression         = space exp:expression_content space ('\n' / ';' )+  space { return exp }
  expression_content            = message_send / infix / literal / paren_expression
  paren_expression              = '(' exp:expression ')' { return exp }

  message_send                  = '[' r:expression_content mandatory_space m:expression_content ']' { return { receiver:r, message:m } } / 
                                  '[' r:expression_content mandatory_space m:naked_scope ']' { return { receiver:r, message:m } } 

  literal                       = scope / string / number / label

  scope                         = '{' exps:expression+ last:expression? '}' { exps = exps.concat(last == "" ? [] : [last]); exps.push( { 'return':exps.pop() }); return { scope:exps } } /
                                  '{' e:expression '}' { return { scope:[{'return':e}] } } /
                                  '{' space '}' { return { scope:[{'return':null}] } }
  naked_scope                   = exps:expression+ { exps.push( { 'return':exps.pop() }); return { scope:exps } }

  infix                         = lhs:(literal) space op:operator space rhs:expression_content { return { infix:op, lhs:lhs, rhs:rhs } }
  operator                      = o:[~`!@#\$%\^*\-+|<>&\?,.\/\\=:]+ { return o.join('') }

  label                         = l:[a-zA-Z_\-]+ { return { label:l.join('') } }

  string                        = single_quoted_string / double_quoted_string
  double_quoted_string          = '"' s:[^"]+ '"' { return s.join('') }
  single_quoted_string          = "'" s:[^ \n;\{\}\(\)]+ { return s.join('') }

  number                        = float_between_01 / float / integer
  float                         = n:digit+ '.' m:digit+ { return parseFloat( n.join('') + "." + m.join('') )}
  float_between_01              = '.' n:digit+ { return parseFloat( "0." + n.join('') )}
  integer                       = n:digit+ { return parseInt(n.join('')) }
  digit                         = [0123456789]

  space                         = [ ]* { return undefined }
  mandatory_space               = [ ]+ { return undefined }
</pre>

<h3>Number Literals</h3>
<pre class="good">20</pre>
<pre class="good">.75</pre>
<pre class="good">42.13</pre>

<h3>String Literals</h3>
<pre class="good">"double quote"</pre>
<pre class="good">'single</pre>
<pre class="good">'*</pre>

<h3>Labels</h3>
<pre class="good">label</pre>
<pre class="good">hyphenated-label</pre>

<h3>Operators</h3>
<pre class="good">infix: 1</pre>
<pre class="good">30 = 50</pre>
<pre class="good">complex ?::= operators</pre>
<pre class="good">subtract - labels</pre>

<h3>Scopes</h3>
<pre class="good">{ 'scope }</pre>
<pre class="good">{ 'scope; }</pre>
<pre class="good">{ }</pre>
<pre class="good">{ a=1; b=1 }</pre>
<pre class="good">{ a=1; b=1; }</pre>
<pre class="good">{ scope-as:"record"; name='ramsey; age=26; job='hacker }</pre>
<pre class="good">{ multi: line
name = 'ramsey
age  = 26
job  = 'hacker }</pre>
<pre class="good">square = { x * x }</pre>
<pre class="good">{ sub-scope: { name = 'nested } }</pre>
<pre class="good">{ sub-scope: { name = 'nested } }</pre>
<pre class="good">[draw-point {x:2; y:90}]</pre>
<pre class="good">[draw-point {x:2 y:90}]</pre>
<pre class="good">[draw-point x:2 y:90]</pre>
<pre class="good">[{x:20} x:2 y:90]</pre>
<pre class="good">draw-point x:2 y:90</pre>

<h3>Sandbox</h3>
<pre class="good">fib = { n < 2 if-true: { n } else: { fib:n-1 + fib:n-2 } }</pre>
<pre class="good">{ 0:'ramsey }</pre>
<pre class="good">result = [square x=12]</pre>
<pre class="good">result = square x=12</pre>
<pre class="good">result = square ! x=12</pre>
<pre class="good">square = { x * x }
result = [square x=12]</pre>
<pre class="good">square = { value = x * x }
result = [[square x=12] value]</pre>
<pre class="good">square = { value = [multiply a=x b=x] }
result = [[square x=12] value]</pre>
